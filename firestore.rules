rules_version = '2';

service cloud.firestore {
match /databases/{database}/documents {

// Helper functions
function isAuthenticated() {
return request.auth != null;
}

function isOwner(userId) {
return isAuthenticated() && request.auth.uid == userId;
}

function hasRole(role) {
return isAuthenticated() &&
get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
}

function isAdmin() {
return hasRole('admin');
}

function isSupplier() {
return hasRole('supplier');
}

function isCustomer() {
return hasRole('customer');
}

// Users collection
match /users/{userId} {
// Users can read their own data, admins can read all
allow read: if isOwner(userId) || isAdmin();

// Users can create their own account on signup
allow create: if isAuthenticated() && request.auth.uid == userId;

// Users can update their own data, admins can update any
allow update: if isOwner(userId) || isAdmin();

// Only admins can delete users
allow delete: if isAdmin();
}

// Products collection
match /products/{productId} {
// Anyone can read active products
allow read: if resource.data.active == true || isAuthenticated();

// Suppliers can create products for themselves
allow create: if isSupplier() && request.resource.data.supplierId == request.auth.uid;

// Suppliers can update their own products, admins can update any
allow update: if (isSupplier() && resource.data.supplierId == request.auth.uid) || isAdmin();

// Suppliers can delete their own products, admins can delete any
allow delete: if (isSupplier() && resource.data.supplierId == request.auth.uid) || isAdmin();
}

// Orders collection
match /orders/{orderId} {
// Customers can read their own orders
// Suppliers can read orders containing their products
// Admins can read all orders
allow read: if isOwner(resource.data.customerId) ||
isAdmin() ||
(isSupplier() && request.auth.uid in resource.data.supplierIds);

// Only authenticated customers can create orders
allow create: if isCustomer() && request.resource.data.customerId == request.auth.uid;

// Customers can update their own orders (cancel, etc.)
// Suppliers can update order status for their items
// Admins can update any order
allow update: if isOwner(resource.data.customerId) ||
isAdmin() ||
(isSupplier() && request.auth.uid in resource.data.supplierIds);

// Only admins can delete orders
allow delete: if isAdmin();
}

// Reviews collection
match /reviews/{reviewId} {
// Anyone can read approved reviews
allow read: if resource.data.approved == true || isAuthenticated();

// Customers can create reviews for their purchased products
allow create: if isCustomer() && request.resource.data.customerId == request.auth.uid;

// Users can update their own reviews, admins can update any
allow update: if isOwner(resource.data.customerId) || isAdmin();

// Users can delete their own reviews, admins can delete any
allow delete: if isOwner(resource.data.customerId) || isAdmin();
}

// Categories collection
match /categories/{categoryId} {
// Anyone can read active categories
allow read: if resource.data.active == true || isAuthenticated();

// Only admins can create/update/delete categories
allow create, update, delete: if isAdmin();
}

// Coupons collection
match /coupons/{couponId} {
// Authenticated users can read active coupons
allow read: if isAuthenticated() && resource.data.active == true;

// Only admins can manage coupons
allow create, update, delete: if isAdmin();
}

// Notifications collection
match /notifications/{notificationId} {
// Users can read their own notifications
allow read: if isOwner(resource.data.userId);

// System can create notifications
allow create: if isAuthenticated();

// Users can update their own notifications (mark as read)
allow update: if isOwner(resource.data.userId);

// Users can delete their own notifications
allow delete: if isOwner(resource.data.userId);
}

// Analytics collection (admin only)
match /analytics/{document=**} {
allow read, write: if isAdmin();
}

// Settings collection (admin only)
match /settings/{document=**} {
allow read: if isAuthenticated();
allow write: if isAdmin();
}

// Deny all other access by default
match /{document=**} {
allow read, write: if false;
}
}
}